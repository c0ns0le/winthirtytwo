<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>winthirtytwo by dataweapons</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/dataweapons/winthirtytwo">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/dataweapons/winthirtytwo/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/dataweapons/winthirtytwo/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>winthirtytwo</h1>
          <p>Repository for windows implementation.</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/dataweapons">dataweapons</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <p>for ballerz yo</p>

<h2>
<a id="00-install" class="anchor" href="#00-install" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>[00] INSTALL</h2>

<h3>
<a id="install-service-bus-locally" class="anchor" href="#install-service-bus-locally" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install service bus locally.</h3>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/azure/jj193014(v=azure.10).aspx">Installing and Configuring Service Bus for Windows Server</a></li>
<li>click <a href="http://go.microsoft.com/fwlink/?LinkID=252361">here</a>.</li>
</ul>

<div class="highlight highlight-source-css"><pre># Run in Service Bus PowerShell Console

# Create new SB Farm
$SBCertificateAutoGenerationKey = ConvertTo-SecureString -AsPlainText -Force -String "A <span class="pl-ent">strong</span> auto generation key"

New-SBFarm -SBFarmDBConnectionString 'Data Source=localhost;Initial Catalog=SbManagementDB;Integrated Security=True' -InternalPortRangeStart 9000 -HttpsPort 9355 -TcpPort 9354 -MessageBrokerPort 9356 -RunAsName 'userName@domain' -AdminGroup 'BUILTIN\Administrators' -GatewayDBConnectionString 'Data Source=localhost;Initial Catalog=SbGatewayDatabase;Integrated Security=True' -CertificateAutoGenerationKey $SBCertificateAutoGenerationKey -MessageContainerDBConnectionString 'Data Source=localhost;Initial Catalog=ServiceBusDefaultContainer;Integrated Security=True';


# Add SB Host
$SBRunAsPassword = ConvertTo-SecureString -AsPlainText -Force -String <span class="pl-ent">*****</span> Replace with RunAs Password for Service Bus in single quote <span class="pl-ent">******</span>;

Add-SBHost -SBFarmDBConnectionString 'Data Source=localhost;Initial Catalog=SbManagementDB;Integrated Security=True' -RunAsPassword $SBRunAsPassword -EnableFirewallRules $true -CertificateAutoGenerationKey $SBCertificateAutoGenerationKey;

# Create new SB Namespace
New-SBNamespace -Name 'ServiceBusDefaultNamespace' -AddressingScheme 'Path' -ManageUsers 'userName@domain';

# Get SB Client Configuration
$SBClientConfiguration = Get-SBClientConfiguration -Namespaces 'ServiceBusDefaultNamespace';
</pre></div>

<h3>
<a id="install-azure-cli-from-here" class="anchor" href="#install-azure-cli-from-here" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>install Azure CLI from <a href="http://aka.ms/webpi-azure-cli">here</a>
</h3>

<h3>
<a id="install-azure-powershell-here" class="anchor" href="#install-azure-powershell-here" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>install Azure Powershell <a href="http://aka.ms/webpi-azps">here</a>
</h3>

<div class="highlight highlight-source-css"><pre># Install the Azure Resource Manager modules from the PowerShell Gallery
Install-Module AzureRM

# Install the Azure Service Management module from the PowerShell Gallery
Install-Module Azure

# To make sure the Azure PowerShell module is available after you install
Get-Module –ListAvailable 

# To login to Azure Resource Manager
Login-AzureRmAccount

# You can also use <span class="pl-ent">a</span> specific Tenant if you would like <span class="pl-ent">a</span> faster login experience
# Login-AzureRmAccount -TenantId xxxx

# To view all subscriptions for your account
Get-AzureRmSubscription

# To <span class="pl-ent">select</span> <span class="pl-ent">a</span> default subscription for your current session
Get-AzureRmSubscription –SubscriptionName “your <span class="pl-ent">sub</span>” | Select-AzureRmSubscription

# View your current Azure PowerShell session context
# This session state is only applicable to the current session and will not affect other sessions
Get-AzureRmContext

# To <span class="pl-ent">select</span> the default storage context for your current session
Set-AzureRmCurrentStorageAccount –ResourceGroupName “your resource group” –StorageAccountName “your storage account name”

# View your current Azure PowerShell session context
# Note: the CurrentStorageAccount is now set in your session context
Get-AzureRmContext

# To list all of the blobs in all of your containers in all of your accounts
Get-AzureRmStorageAccount | Get-AzureStorageContainer | Get-AzureStorageBlob</pre></div>

<h2>
<a id="01-setup" class="anchor" href="#01-setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>[01] SETUP</h2>

<h3>
<a id="configure-office365" class="anchor" href="#configure-office365" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>configure office365.</h3>

<ul>
<li>start <a href="https://support.office.com/en-us/article/Add-users-and-domain-to-Office-365-6383f56d-3d09-4dcb-9b41-b5f5a5efd611?CorrelationId=f96b8eb8-166b-4be2-90eb-e9138b03c1f5&amp;ui=en-US&amp;rs=en-US&amp;ad=US">here</a>
</li>
<li>do this:</li>
</ul>

<div class="highlight highlight-source-css"><pre>$dom = "&lt;domain<span class="pl-e">.name</span>&gt;"

set-msoldomain -name $dom -IsDefault
set-MsolDomainAuthentication -Authentication Managed -DomainName $dom

<span class="pl-e">#The</span> following commands convert the existing domain to use single sign-on. Notice the certificate is in Base-64 encoding:
convert-MsolDomainToFederated

$brand = "brand Ltd."
$ActiveSO = "https://adfs.$dom/adfs/services/trust/2005/usernamemixed"
$PLUri$ = "https://adfs.$dom/adfs/ls"
$IssuerUri = "https://adfs.$dom/adfs/services/trust"
$cert = "MIIEQzCCAyugAwIBAgIKYQm1CwAAAAAAEDANBgkqhkiG9w0BAQUFADBIMRMwEQYK
CZImiZPyLGQBGRYDY29tMR0wGwYKCZImiZPyLGQBGRYNd29vZGdyb3ZlYmFuazES
MBAGA1UEAxMJRGVudmVyLUNBMB4XDTEwMDExMDA2NDEwMFoXDTExMTExMTAxMTM0
MFowIzEhMB8GA1UEAxMYZGVudmVyLndvb2Rncm92ZWJhbmsuY29tMIIBIjANBgkq
hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApUaiuxFkfXf9O5kUSpxOBSBFhjFirBb3
ddcs2weW/4cMniVNYGanLABVuqltfRHqWz6WZF/98VbqfCaETBaKu/QggcuhMoBc
yT7E4n35GOFxf8OVUy38VI1BrFon/crs8IUc0pK3qKG0n4rsCRwnpxoEPar0MiSP
r8jpDZa/eLcMV/1lFifpNXz2v1wKWYRKXrvg1sLJyABSRoAZShxaMcXehS0egmiP
gYNhvZln2Z/M2Xwy5oh21lAjzbrW2eLmsqr1OTsFO497CBsuoWS4KQUbxf7hVj3T
tgPXTphJsg6+2606nlJqflsxjpH90ucendRZVPJ1Vs83yMUcPUyA+QIDAQABo4IB
UjCCAU4wDgYDVR0PAQH/BAQDAgWgMD0GCSsGAQQBgjcVBwQwMC4GJisGAQQBgjcV
CIP16AeH74RRh62DOIaW7CWEl7BNJ4bS92uFwqxxAgFkAgECMB0GA1UdDgQWBBQ6
RGMSiX+JPfV4zEGxeXGeFXm1kzAfBgNVHSMEGDAWgBSZzCX7ueHUBH7PY6wVldwn
N/ntwjA/BgNVHR8EODA2MDSgMqAwhi5odHRwOi8vcGtpLndvb2Rncm92ZWJhbmsu
Y29tL0NEUC9EZW52ZXItQ0EuY3JsMEoGCCsGAQUFBwEBBD4wPDA6BggrBgEFBQcw
AoYuaHR0cDovL3BraS53b29kZ3JvdmViYW5rLmNvbS9BSUEvRGVudmVyLUNBLmNy
dDATBgNVHSUEDDAKBggrBgEFBQcDATAbBgkrBgEEAYI3FQoEDjAMMAoGCCsGAQUF
BwMBMA0GCSqGSIb3DQEBBQUAA4IBAQCVaxdQ2nO5cpo0AQL+Pk/hXs3JOe+cRD1F
q4QZzAtef7viv4By6RI4xvbjap5iRs3wzWBuRdTT4zKcTZrUkBuyo3rxkmy8dzbh
0nXFrIS6onvPQDAxXLgz8b/YnlfnpCH1t/FoH6lqjmsiESYtfj43j8epDg91OhvQ
hirX2Q+27LBEvf9pmG/Nc7WXlm38UI1tpHw9lYqEOde2bxz7o2hgLcZg8ptJx4ci
PnB9VyrfTjPutLI4GqSuaMqrYxzjVplNkVMV3ZjJc2Jh8mLiaY7iPwRO3zPMs+Vn
hb32hqVF14uxWC4DNO5ccaqTKxUKH0LngEo9GItFhjxGlcg0fwI0"
Set-MsolDomainAuthentication –DomainName $dom -FederationBrandName $brand -Authentication Federated -PassiveLogOnUri $PLUri -SigningCertificate $cert -IssuerUri $IssuerUri -ActiveLogOnUri $ActiveSO -LogOffUri $PLUri

Set-MsolPasswordPolicy DomainName $dom -NotificationDays 14 -ValidityPeriod 60 </pre></div>

<h3>
<a id="link-domain-to-office365" class="anchor" href="#link-domain-to-office365" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Link domain to office365.</h3>

<div class="highlight highlight-source-css"><pre>SynchronizeUpnForManagedUsers-Enable $True</pre></div>

<h3>
<a id="setup-azure-with-on-premises-domain" class="anchor" href="#setup-azure-with-on-premises-domain" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setup azure with on premises domain.</h3>

<div class="highlight highlight-source-css"><pre>$cred=Get-Credential
Connect-MsolService -Credential $cred
Login-AzureRmAccount -Credential $cred
Register-AzureADConnectHealthADDSAgent -Credentials $cred
Get-MsolFederationProperty -DomainName $dom | FL Source, TokenSigningCertificate
Update-MsolFederatedDomain
Get-ADFSCertificate –CertificateType token-signing
Update-ADFSCertificate –CertificateType token-signing
Set-MSOLAdfscontext -Computer &lt;ADFS server&gt;
Update-MSOLFederatedDomain –DomainName $dom
MSOLFederatedDomain -DomainName $dom -SupportMultipleDomain
New-MsolFederatedDomain –SupportMultipleDomain –DomainName $dom</pre></div>

<h3>
<a id="support-subdomains" class="anchor" href="#support-subdomains" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support subdomains.</h3>

<ul>
<li>Open AD FS Management</li>
<li>Right click the Microsoft Online RP trust and choose Edit Claim rules</li>
<li>Select the third claim rule, and replace with:</li>
</ul>

<div class="highlight highlight-source-css"><pre>c:[Type == "http://schemas<span class="pl-e">.xmlsoap.org</span>/claims/UPN"] =&gt; issue(Type = "http://schemas<span class="pl-e">.microsoft.com</span>/ws/2008/06/identity/claims/issuerid", Value = regexreplace(c<span class="pl-e">.Value</span>, "^((.<span class="pl-ent">*</span>)([.|@]))?(?&lt;domain&gt;[^.]<span class="pl-ent">*</span>[.].<span class="pl-ent">*</span>)$", "http://${<span class="pl-c1">domain</span>}/adfs/services/trust/"));</pre></div>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
